<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>WebAR Chroma Key Fix</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <script>
        // クロマキーシェーダーの定義（カラーコード対応版）
        AFRAME.registerShader('chromakey', {
            schema: {
                src: {type: 'map'},
                color: {type: 'color', default: '#00FF00'} // 初期値：鮮やかな緑
            },
            init: function(data) {
                const videoTexture = new THREE.VideoTexture(data.src);
                videoTexture.minFilter = THREE.LinearFilter;
                this.material = new THREE.ShaderMaterial({
                    uniforms: {
                        tex: {value: videoTexture},
                        keyColor: {value: new THREE.Color(data.color)}
                    },
                    vertexShader: `
                        varying vec2 vUv;
                        void main() {
                            vUv = uv;
                            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                        }
                    `,
                    fragmentShader: `
                        uniform sampler2D tex;
                        uniform vec3 keyColor;
                        varying vec2 vUv;
                        void main() {
                            vec4 tColor = texture2D(tex, vUv);
                            // 指定色との距離を計算
                            float dist = distance(tColor.rgb, keyColor);
                            // 0.35 の数値を小さくすると判定が厳しくなり、大きくすると広範囲が消えます
                            if (dist < 0.35) {
                                discard;
                            } else {
                                gl_FragColor = tColor;
                            }
                        }
                    `,
                    transparent: true
                });
            }
        });
    </script>
</head>

<body style="margin: 0; overflow: hidden;">
    <div id="start-btn" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; display:flex; justify-content:center; align-items:center; color:white; font-size:20px; font-family:sans-serif; cursor:pointer;">
        タップしてARを開始
    </div>

    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" renderer="colorManagement: true;">
        <a-assets>
            <video id="web-video" src="video.mp4#t=0.001" preload="auto" loop="true" crossorigin="anonymous" playsinline webkit-playsinline muted></video>
        </a-assets>

        <a-marker preset="hiro">
            <a-entity geometry="primitive: plane; width: 2; height: 1.125"
                      rotation="0 0 0"
                      position="0 1 0" 
                      material="shader: chromakey; src: #web-video; color: #00FF00">
            </a-entity>
        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        const btn = document.getElementById('start-btn');
        const video = document.getElementById('web-video');

        btn.addEventListener('click', function() {
            video.play().then(() => {
                btn.style.display = 'none';
            }).catch(err => {
                console.log("Video play error:", err);
                video.muted = true;
                video.play();
                btn.style.display = 'none';
            });
        });
    </script>
</body>
</html>