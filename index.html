<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>WebAR Fix Final</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <script>
        AFRAME.registerShader('chromakey', {
            schema: {
                src: {type: 'map'},
                color: {type: 'color', default: '#00FF00'},
                threshold: {type: 'number', default: 0.3} // 閾値を調整可能に
            },
            init: function(data) {
                const videoTexture = new THREE.VideoTexture(data.src);
                videoTexture.minFilter = THREE.LinearFilter;
                this.material = new THREE.ShaderMaterial({
                    uniforms: {
                        tex: {value: videoTexture},
                        keyColor: {value: new THREE.Color(data.color)},
                        threshold: {value: data.threshold}
                    },
                    vertexShader: `
                        varying vec2 vUv;
                        void main() {
                            vUv = uv;
                            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                        }
                    `,
                    fragmentShader: `
                        uniform sampler2D tex;
                        uniform vec3 keyColor;
                        uniform float threshold;
                        varying vec2 vUv;
                        void main() {
                            vec4 tColor = texture2D(tex, vUv);
                            // 色の距離を計算
                            float dist = distance(tColor.rgb, keyColor);
                            // 閾値より近い色は透明にする
                            if (dist < threshold) {
                                discard;
                            } else {
                                gl_FragColor = tColor;
                            }
                        }
                    `,
                    transparent: true
                });
            },
            // 数値が書き換わったときに反映させる処理
            update: function(data) {
                this.material.uniforms.keyColor.value.set(data.color);
                this.material.uniforms.threshold.value = data.threshold;
            }
        });
    </script>
</head>

<body style="margin: 0; overflow: hidden;">
    <div id="start-btn" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; display:flex; justify-content:center; align-items:center; color:white; font-size:20px; font-family:sans-serif; cursor:pointer;">
        タップしてARを開始
    </div>

    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
        <a-assets>
            <video id="web-video" src="video.mp4#t=0.001" preload="auto" loop="true" crossorigin="anonymous" playsinline webkit-playsinline muted></video>
        </a-assets>

        <a-marker preset="hiro">
            <a-entity id="ar-video-plane"
                      geometry="primitive: plane; width: 2; height: 1.125"
                      rotation="0 0 0" 
                      position="0 0.6 0"
                      material="shader: chromakey; src: #web-video; color: #00FF00; threshold: 0.3">
            </a-entity>
        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        const btn = document.getElementById('start-btn');
        const video = document.getElementById('web-video');
        const arEntity = document.getElementById('ar-video-plane');

        btn.addEventListener('click', function() {
            video.play();
            btn.style.display = 'none';
        });

        // デバッグ用：背景がうまく抜けない場合は、以下の color の値を微調整してください
        // 例: arEntity.setAttribute('material', 'color', '#12f345');
    </script>
</body>
</html>